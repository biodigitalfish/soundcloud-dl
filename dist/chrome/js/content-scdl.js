import{L as K}from"./logger-scdl-C1suKzoJ.js";import{o as Y,l as le,g as ae,m as re}from"./compatibilityStubs-scdl-DBF9jRnU.js";import{a as se}from"./config-scdl-CB4onbqr.js";class ie{observer;events=[];unqiueNodeId=0;logger;constructor(){this.observer=new MutationObserver(t=>t.forEach(l=>this.handleMutation(l))),this.logger=K.create("Observer")}start(t){this.observer.observe(t,{subtree:!0,attributes:!0,childList:!0}),this.logger.logDebug("Started")}stop(){this.observer.disconnect(),this.logger.logDebug("Stopped")}addEvent(t){if(!t.selector){this.logger.logWarn("Selector was not specified");return}if(!t.callback){this.logger.logWarn("Callback was not specified");return}this.events.push(t),this.logger.logDebug("Event added",t)}removeEvent(t){this.events=this.events.filter(l=>l.name!==t)}handleMutation(t){const l=t.target,n=t.addedNodes??[];for(const s of this.events)n.length>0?this.handleNodes(n,s):t.type==="attributes"&&this.handleNodes([l],s,!1)}handleNodes(t,l,n=!0){if(t)for(let s=0;s<t.length;s++){const d=t[s];if(this.matchesSelectors(d,l.selector)){if(d._id!==void 0)return;d._id=++this.unqiueNodeId,l.callback(d)}n&&d.childNodes?.length>0&&this.handleNodes(d.childNodes,l)}}matchesSelectors(t,l){return t&&t instanceof HTMLElement&&t.matches(l)}}const de=`
  #scdl-range-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
  }
  #scdl-range-modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 350px;
    border-radius: 5px;
    color: #333; /* Ensure text is visible */
  }
  #scdl-range-modal label {
    display: block;
    margin-bottom: 5px;
  }
  #scdl-range-modal input[type="number"] {
    width: 60px;
    padding: 5px;
    margin-bottom: 15px;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
  }
  #scdl-range-modal-actions button {
    padding: 8px 15px;
    margin-left: 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  #scdl-range-modal-download {
    background-color: #ff5419;
    color: white;
  }
  #scdl-range-modal-cancel {
    background-color: #ccc;
  }
  #scdl-range-modal-error {
    color: red;
    font-size: 0.9em;
    margin-top: 10px;
    display: none; /* Hidden by default */
  }
  .sc-button-download {
    transition: background-color 0.5s ease-out;
  }
`;let E=null;function ce(){if(document.getElementById("scdl-range-modal"))return;const e=document.createElement("style");e.textContent=de,document.head.appendChild(e),E=document.createElement("div"),E.id="scdl-range-modal",E.innerHTML=`
    <div id="scdl-range-modal-content">
      <h4>Download Playlist Range</h4>
      <label for="scdl-range-from">From track:</label>
      <input type="number" id="scdl-range-from" name="from" min="1" value="1">
      <label for="scdl-range-to">To track:</label>
      <input type="number" id="scdl-range-to" name="to" min="1" value=""><br>
      <small>(Leave "To" blank to download until the end)</small>
      <div id="scdl-range-modal-error"></div>
      <div id="scdl-range-modal-actions" style="text-align: right; margin-top: 15px;">
        <button id="scdl-range-modal-cancel">Cancel</button>
        <button id="scdl-range-modal-download">Download Selection</button>
      </div>
    </div>
  `,document.body.appendChild(E),document.getElementById("scdl-range-modal-cancel").addEventListener("click",z),E.addEventListener("click",t=>{t.target===E&&z()})}function ue(e,t){E||ce();const l=document.getElementById("scdl-range-from"),n=document.getElementById("scdl-range-to"),s=document.getElementById("scdl-range-modal-error");l.value="1",n.value="",s.textContent="",s.style.display="none";const d=document.getElementById("scdl-range-modal-download"),f=d.cloneNode(!0);d.parentNode.replaceChild(f,d),f.addEventListener("click",()=>{const i=parseInt(l.value,10),_=n.value,w=_?parseInt(_,10):null;if(s.textContent="",s.style.display="none",isNaN(i)||i<1){s.textContent='Invalid "From" number.',s.style.display="block";return}if(w!==null&&(isNaN(w)||w<i)){s.textContent='Invalid "To" number. Must be greater than or equal to "From".',s.style.display="block";return}t(i,w),z(),p(e,"Preparing..."),e.style.cursor="default",e.onclick=null}),E.style.display="block"}function z(){E&&(E.style.display="none")}let R=null;const o=K.create("ContentScript");let B="",J=!1,V=!1;const ge=le,F=(e,t)=>{let l={};try{l=JSON.parse(JSON.stringify(e))}catch{l={errorParsingMessage:!0,originalType:e?.type}}if(o.logDebug("[ContentScript sendMessageToBackend CALLED [Context: "+(t||"Unknown")+"] Message:]",l),e&&typeof e=="object"){if(["DOWNLOAD","DOWNLOAD_SET","DOWNLOAD_SET_RANGE","PAUSE_DOWNLOAD","RESUME_DOWNLOAD"].includes(e.type)&&(!e.downloadId||e.downloadId===void 0||e.downloadId==="undefined")){const n=new Error("CRITICAL: Prevented sending message with type "+e.type+" and missing downloadId!");return o.logError("[ContentScript loggedSendMessageToBackend]",n.message,{message:l,callContext:t}),Promise.reject(n)}e.timestamp||(e.timestamp=Date.now())}return ge(e)},r={},p=(e,t,l)=>{e.innerText=t,e.title=l??t},k=e=>{e.style.backgroundColor="",e.style.background="",e.style.color=""},me=(e,t)=>{const l=crypto.randomUUID().substring(0,8),n=Object.keys(r);let s="<payload_serialization_error>";try{s=JSON.stringify(e)}catch{}let d="<sender_serialization_error>";try{d=JSON.stringify(t)}catch{}o.logDebug("[HANDLE_MSG_FROM_BG_ENTRY_POINT CALL_ID: "+l+"] Invoked. Payload: "+s+". Sender: "+d+". Current downloadButton keys: "+(n.join(",")||"none"));const f=["downloadId","progress","error","status","browserDownloadId","originalDownloadId","completionWithoutId","completed","success","timestamp","scdl_test_message"],i=Object.keys(e||{}),_=i.some(P=>f.includes(P));if(!_&&i.length>0)return o.logWarn("[HANDLE_MSG_FROM_BG] Discarding irrelevant message by key filter. Payload:",JSON.parse(JSON.stringify(e))),Promise.resolve({handled:!1,reason:"Irrelevant message"});_&&o.logDebug("[HANDLE_MSG_FROM_BG] Relevant message PASSED initial filter. Payload:",JSON.parse(JSON.stringify(e)));const{downloadId:w,progress:c,error:D,status:h,completionWithoutId:m,completed:u,timestamp:x,browserDownloadId:G,originalDownloadId:b}=e;let a;if(b?(a=b,o.logDebug("[CS_FID_LOGIC CALL_ID: "+l+"] finalDownloadId set from message.originalDownloadId: "+a)):w?(a=w,o.logDebug("[CS_FID_LOGIC CALL_ID: "+l+"] finalDownloadId set from message.downloadId: "+a)):(o.logWarn("[CS_FID_LOGIC CALL_ID: "+l+"] Message has neither originalDownloadId nor downloadId at the top level of payload."),e&&e.error&&e.originalMessage&&typeof e.originalMessage.downloadId=="string"&&(a=e.originalMessage.downloadId,o.logInfo("[CS_FID_LOGIC CALL_ID: "+l+"] finalDownloadId recovered from message.originalMessage.downloadId due to error payload from bridge: "+a))),!a&&G){const P=Object.keys(r).filter(I=>r[I].browserDownloadId===G);if(P.length===1){if(a=P[0],o.logDebug("[CS_FID_LOGIC] finalDownloadId set from browserDownloadId match: "+a),c===101||u===!0){const I=r[a];return k(I.elem),I.elem.style.backgroundColor="#19a352",p(I.elem,"Downloaded!"),I.elem.title="Downloaded successfully (matched by browser downloadId)",I.elem.onclick=null,I.state="Downloaded",I.resetTimer=window.setTimeout(()=>L(a),1e4),o.logDebug("[CS_FID_LOGIC] Updated button "+a+" to Downloaded state from browserDownloadId match"),Promise.resolve({handled:!0,id:a})}}else P.length>1&&o.logWarn("[CS_FID_LOGIC] Found multiple ("+P.length+") buttons with browserDownloadId="+G+". Cannot reliably map message.")}if(!a||a==="undefined_completion"||m){o.logWarn("[CS_GENERIC_MATCH_ENTRY] Entering generic/undefined ID matching. finalDownloadId: "+a+", is_undefined_completion: "+(a==="undefined_completion")+", completionWithoutId flag: "+m+". Message payload:",JSON.parse(JSON.stringify(e)));const P=["Downloading","Preparing","Finishing","Pausing","Resuming"],I=Object.keys(r).filter(S=>P.includes(r[S].state)),O=c===void 0&&h===void 0&&u!==!0&&m!==!0&&D===void 0&&typeof e=="object"&&Object.keys(e).length<=(b?5:e.type?2:1);if(I.length===0&&O)return o.logWarn("[HANDLE_MSG_FROM_BG] Received minimal message (keys: "+(Object.keys(e).join(", ")||"none")+") with no active downloads. Discarding.",{message:e}),Promise.resolve({handled:!1,reason:"Minimal message, no active downloads"});if(o.logWarn("[HANDLE_MSG_FROM_BG] Received message (keys: "+(Object.keys(e).join(", ")||"none")+") without a usable finalDownloadId or it is a generic completion. Attempting to match with active downloads (found "+I.length+" using states: "+P.join(", ")+")."),c===101||c===102||u===!0||m===!0||h===void 0&&D===void 0&&typeof e=="object"&&Object.keys(e).length<=(b?5:4)){const S=I;if(o.logWarn("[HANDLE_MSG_FROM_BG] Attempting to match as completion message. Found "+S.length+" candidates using states: "+P.join(", ")+"."),S.length===1){const M=S[0];if(o.logWarn("[HANDLE_MSG_FROM_BG] Matched undefined/generic ID message to single active download: "+M),a=M,c===101||c===102||u===!0||m===!0){const C=r[a];return k(C.elem),C.elem.style.backgroundColor="#19a352",p(C.elem,"Downloaded!"),C.elem.title="Downloaded successfully (auto-matched generic completion)",C.elem.onclick=null,C.state="Downloaded",C.resetTimer=window.setTimeout(()=>L(a),1e4),o.logWarn("[HANDLE_MSG_FROM_BG] Updated button "+a+" to Downloaded state from matched generic completion message."),Promise.resolve({handled:!0,id:a})}}else if(S.length>1&&x){let M=null,C=0;if(S.forEach(v=>{const X=r[v].lastProgressTime||0;X>C&&(C=X,M=v)}),M){if(o.logWarn("[HANDLE_MSG_FROM_BG] Matched undefined/generic ID to most recent active download by timestamp: "+M),a=M,c===101||c===102||u===!0||m===!0){const v=r[a];return k(v.elem),v.elem.style.backgroundColor="#19a352",p(v.elem,"Downloaded!"),v.elem.title="Downloaded successfully (auto-matched generic completion by timestamp)",v.elem.onclick=null,v.state="Downloaded",v.resetTimer=window.setTimeout(()=>L(a),1e4),o.logWarn("[HANDLE_MSG_FROM_BG] Updated button "+a+" to Downloaded state from timestamp-matched generic completion message."),Promise.resolve({handled:!0,id:a})}}else o.logWarn("[HANDLE_MSG_FROM_BG] Found "+S.length+" active downloads, but couldn't match generic completion message by timestamp.")}else S.length>0?o.logWarn("[HANDLE_MSG_FROM_BG] Found "+S.length+" active downloads, can't match generic completion message reliably by unique or timestamp."):o.logWarn("[HANDLE_MSG_FROM_BG] No active downloads to match generic completion message to.")}if(!a)return I.length===0&&O?o.logWarn("[HANDLE_MSG_FROM_BG] Could not determine finalDownloadId for minimal message (no active downloads) after matching attempts. Discarding.",{message:e}):o.logWarn("[HANDLE_MSG_FROM_BG] Could not determine finalDownloadId from generic message after all attempts. Discarding.",{message:e}),Promise.resolve({handled:!1,reason:"Could not determine finalDownloadId from generic message"})}if(!a)return o.logDebug("[HANDLE_MSG_FROM_BG] CRITICAL: finalDownloadId is null/undefined after all matching attempts. Discarding message.",e),Promise.resolve({handled:!1,reason:"finalDownloadId null after all matching"});const N=r[a];if(!N){const P=typeof e.error=="object"&&e.error!==null,I=typeof e.error=="string"&&e.error!=="";if(e.progress!==void 0&&e.progress>=100&&e.progress<=102||e.completed===!0||P||I){const O="progress: "+e.progress+", completed: "+e.completed+", error: '"+(e.error||"none")+"'";return o.logInfo("[HANDLE_MSG_FROM_BG CALL_ID: "+l+"] Button data not found for finalDownloadId: "+a+". Classified as late finalization ("+O+"). Likely already cleaned up. Message:",JSON.parse(JSON.stringify(e))),Promise.resolve({handled:!0,reason:"Button data not found, late finalization ("+O+")"})}else{const O=Object.keys(r);let S="<payload_serialization_error_in_warning>";try{S=JSON.stringify(e)}catch{}return o.logWarn("[HANDLE_MSG_FROM_BG CALL_ID: "+l+"] Button data not found for finalDownloadId: "+a+" (AND NOT a recognized late finalization type). Message: "+S+". All downloadButton keys at this point: "+O.join(",")||"none"),Promise.resolve({handled:!1,reason:"Button data not found for finalDownloadId (and not a recognized late finalization type)"})}}const{elem:g,resetTimer:Ee,state:y}=N;if(o.logDebug("[HANDLE_MSG_FROM_BG] Processing for finalDownloadId: "+a+". Current button state: "+y+". Message progress: "+c+", success: "+e.success),(y==="Downloaded"||y==="Error")&&(c!==void 0||h!==void 0))return o.logWarn("[HANDLE_MSG_FROM_BG] Received message for already finalized downloadId "+a+" (state: "+y+"). Ignoring for UI update. Message:",e),Promise.resolve({handled:!0,id:a,reason:"Already in "+y+" state"});if(e.error===""&&e.success===void 0&&c===void 0&&h===void 0&&u===void 0&&y!=="Preparing"&&b===a)return o.logDebug("[HANDLE_MSG_FROM_BG] Received redundant simple acknowledgment for "+a+" while button state is "+y+". Ignoring for UI update. Payload:",JSON.parse(JSON.stringify(e))),Promise.resolve({handled:!0,id:a,reason:"Redundant simple ack, state not Preparing"});if(e.success===!0&&typeof e.message=="string"&&e.message.includes("added to queue")&&b===a&&y==="Preparing"&&c===void 0&&h===void 0&&u===void 0)o.logDebug("[HANDLE_MSG_FROM_BG] 'Added to Queue' ack for "+a+". Updating button text."),p(g,"Queued (0%)"),g.style.cursor="default",r[a].state="Queued",r[a].lastProgressTime=Date.now();else if((e.success===!0&&!D||e.error===""&&e.success===void 0)&&b===a&&y==="Preparing"&&c===void 0&&h===void 0&&u===void 0)o.logDebug("[HANDLE_MSG_FROM_BG] Initial command success (non-queue ack) for "+a+". Transitioning to Downloading state."),p(g,"Downloading... (Click to Pause)"),g.style.background="linear-gradient(90deg, #ff5419 0%, transparent 0%)",g.style.cursor="pointer",g.onclick=A(a),r[a].state="Downloading",r[a].lastProgressTime=Date.now();else if(c===101)o.logDebug("[HANDLE_MSG_FROM_BG] Download complete (101) for finalDownloadId="+a),k(g),g.style.backgroundColor="#19a352",p(g,"Downloaded!"),g.title="Downloaded successfully",g.onclick=null,r[a].state="Downloaded",r[a].resetTimer=window.setTimeout(()=>L(a),1e4);else if(c===102)o.logDebug("[HANDLE_MSG_FROM_BG] Download complete with errors (102) for finalDownloadId="+a),k(g),g.style.backgroundColor="gold",g.style.color="#333",p(g,"Downloaded!"),g.title=D||"Some tracks failed to download",g.onclick=null,r[a].state="Downloaded",r[a].resetTimer=window.setTimeout(()=>L(a),3e4);else if(h==="Paused")o.logDebug("[HANDLE_MSG_FROM_BG] Button state updated to Paused, finalDownloadId="+a),k(g),p(g,"Paused (Click to Resume)"),g.style.cursor="pointer",g.onclick=A(a),r[a].state="Paused";else if(h==="Resuming")y==="Paused"?(o.logInfo("[HANDLE_MSG_FROM_BG] Transitioning from Paused to Resuming via background message for "+a+"."),p(g,"Resuming..."),g.style.cursor="default",g.onclick=null,r[a].state="Resuming"):y==="Resuming"?o.logDebug("[HANDLE_MSG_FROM_BG] Confirmed 'Resuming' state via background message for "+a+"."):y==="Downloading"?o.logWarn("[HANDLE_MSG_FROM_BG] Received 'Resuming' status for "+a+" while already 'Downloading'. Ignoring."):o.logWarn("[HANDLE_MSG_FROM_BG] Received 'Resuming' status for "+a+" with unexpected current state '"+y+"'. Ignoring.");else if(c===100||c>100&&c<101)y!=="Paused"&&y!=="Pausing"&&y!=="Resuming"&&(o.logDebug("[HANDLE_MSG_FROM_BG] Button state updated to Finishing, finalDownloadId="+a),p(g,"Finishing..."),g.style.background="linear-gradient(90deg, #ff5419 100%, transparent 0%)",g.onclick=null,r[a].state="Finishing");else if(c!==void 0&&c>=0&&c<100){if(y==="Pausing"||y==="Paused")return o.logDebug("[HANDLE_MSG_FROM_BG] Progress update ("+c+"% for "+a+" received while state is '"+y+"'. Ignoring UI update to prevent flicker."),Promise.resolve({handled:!0,id:a,reason:"Ignoring download progress while pausing/paused"});o.logDebug("[HANDLE_MSG_FROM_BG] Button state updated to Downloading ("+c+"%), finalDownloadId="+a),p(g,"Downloading... (Click to Pause)"),g.style.background="linear-gradient(90deg, #ff5419 "+c+"%, transparent 0%)",(y!=="Downloading"||!g.onclick)&&(g.style.cursor="pointer",g.onclick=A(a)),r[a].state="Downloading",r[a]&&(r[a].lastProgressTime=Date.now())}else D?(o.logWarn("[HANDLE_MSG_FROM_BG] Button state updated to Error: "+D+", finalDownloadId="+a),k(g),g.style.backgroundColor="#d30029",p(g,"ERROR",D),g.onclick=null,r[a].state="Error"):y==="Preparing"&&c!==void 0&&(o.logDebug("[HANDLE_MSG_FROM_BG] Button state forcibly updated from Preparing to Downloading, finalDownloadId="+a),p(g,"Downloading... (Click to Pause)"),g.style.background="linear-gradient(90deg, #ff5419 "+(c||0)+"%, transparent 0%)",g.style.cursor="pointer",g.onclick=A(a),r[a].state="Downloading");return Promise.resolve({handled:!0,id:a,finalState:r[a]?.state})};o.logDebug("[CONTENT_SCRIPT_LISTENER_SETUP] Attempting to set up onMessage listener NOW."),typeof Y<"u"?(Y(me),o.logDebug("[CONTENT_SCRIPT_LISTENER_SETUP] onMessage listener setup complete. Document readyState: "+document.readyState)):o.logDebug("[CONTENT_SCRIPT_SETUP_ERROR] onMessage utility is not defined!");const pe=e=>{const t=document.createElement("button"),l=e?"sc-button-small":"sc-button-medium";return t.className="sc-button-download sc-button "+l+" sc-button-responsive",p(t,"Download"),t},W=e=>{const t=e.includes("/sets/")||e.includes("/albums/");o.logDebug("createDownloadCommand: URL="+e+", isSetUrl="+t,{url:e,isSetUrl:t});const l=n=>n?F({type:t?"DOWNLOAD_SET":"DOWNLOAD",url:e,downloadId:n},"createDownloadCommand"):(o.logError("Attempted to send DOWNLOAD command with undefined/empty downloadId",{url:e}),Promise.reject("Undefined/empty downloadId for DOWNLOAD command"));return l.url=e,l.isSet=t,o.logDebug("createDownloadCommand: Created command with isSet="+l.isSet+", commandUrl: "+l.url+", isSet: "+l.isSet),l},U=(e,t,l)=>{if(e.querySelector("button.sc-button-download")!==null){o.logDebug("Download button already exists");return}o.logDebug("Adding download button",{parentNode:e.nodeName,url:t.url,isSet:t.isSet});const n=pe(l),s=t.url;o.logInfo("Button created with URL: "+s);const d=async()=>{const i=crypto.randomUUID();r[i]={elem:n,onClick:d,state:"Preparing",originalUrl:s,lastProgressTime:Date.now()},o.logInfo("Button clicked with downloadId: "+i+", URL: "+s),n.style.cursor="default",n.onclick=null,p(n,"Preparing..."),k(n);const _=setTimeout(()=>{const c=r[i];c&&c.state==="Preparing"&&(o.logWarn("Safety timeout triggered for downloadId="+i+", button still in Preparing state"),p(n,"Timeout (Retry?)"),n.title="Download request timed out. Click to try again.",n.style.backgroundColor="#d30029",n.style.cursor="pointer",n.onclick=d,r[i].state="Error")},1e4),w=setTimeout(()=>{const c=r[i];if(c&&c.state==="Downloading"){const D=c.lastProgressTime||0,h=Date.now()-D;h>12e4&&(o.logWarn("Completion safety timeout triggered for downloadId="+i+". Download seems stuck in Downloading state for "+h/1e3+"s"),h>18e4?(o.logInfo("Assuming potential silent completion for downloadId="+i),k(n),n.style.backgroundColor="#19a352",p(n,"Downloaded!"),n.title="Download likely completed (auto-detected)",n.onclick=null,r[i].state="Downloaded",r[i].resetTimer=window.setTimeout(()=>L(i),1e4)):(o.logInfo("Marking download "+i+" as potentially stuck"),p(n,"Downloading... (may be stuck)")))}},3e5);try{const c=await t(i);o.logInfo("Download command response for "+i+":",c),clearTimeout(_);const D=r[i];D&&D.state==="Preparing"&&(o.logInfo("Manually transitioning button from Preparing to Downloading state for "+i),p(n,"Downloading... (Click to Pause)"),n.style.background="linear-gradient(90deg, #ff5419 0%, transparent 0%)",n.style.cursor="pointer",n.onclick=A(i),r[i].state="Downloading",r[i].lastProgressTime=Date.now())}catch(c){clearTimeout(_),clearTimeout(w),o.logError("Initial download command failed for "+s,c),r[i]&&(r[i].state="Error",p(n,"ERROR",c.message||"Failed to start"),n.style.backgroundColor="#d30029")}};n.oncontextmenu=i=>{i.preventDefault(),i.stopPropagation();const _=document.getElementById("scdl-context-menu");_&&document.body.removeChild(_);const w=document.createElement("div");w.id="scdl-context-menu",w.style.position="absolute",w.style.left=""+i.pageX+"px",w.style.top=""+i.pageY+"px",w.style.background="#fff",w.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",w.style.padding="5px 0",w.style.borderRadius="3px",w.style.zIndex="10000",document.body.appendChild(w);const c=()=>{document.getElementById("scdl-context-menu")&&document.body.removeChild(w),document.removeEventListener("click",c)};return document.addEventListener("click",c),!1},n.onclick=d,e.appendChild(n);const f=t.isSet;if(o.logInfo("Checking if should add range button:",{isSet:f,url:t.url,urlIncludes:{sets:t.url?.includes("/sets/"),albums:t.url?.includes("/albums/")},browserType:typeof browser<"u"?"Firefox":"Chrome"}),re(s,f)){const i=document.createElement("button");o.logInfo("Creating range button for URL="+(t.url||"unknown"));const _=l?"sc-button-small":"sc-button-medium";i.className="sc-button-range sc-button "+_+" sc-button-responsive",i.textContent="Range...",i.title="Download a range of tracks",i.style.marginLeft="5px",i.onclick=w=>{w.preventDefault(),w.stopPropagation();const c=crypto.randomUUID();r[c]={elem:n,onClick:d,state:"Idle",originalUrl:s,lastProgressTime:Date.now()},o.logInfo("Range button clicked. Created preDownloadId: "+c+", with URL: "+s),ue(n,(D,h)=>{const m=c;o.logInfo("Range download handler called with start="+D+", end="+h+", mainButtonId="+m);const u=r[m];if(o.logInfo("Button data for range download:",{hasButtonData:!!u,originalUrl:u?.originalUrl,state:u?.state}),!u||!u.originalUrl){o.logError("Range download failed: No button data or URL for ID "+m);const b=document.getElementById("scdl-range-modal-error");b&&(b.textContent="Error: Could not get original URL for the playlist.",b.style.display="block");return}p(u.elem,"Preparing..."),u.elem.style.cursor="default",u.elem.onclick=null,u.state="Preparing",u.lastProgressTime=Date.now();const x=setTimeout(()=>{r[m]&&r[m].state==="Preparing"&&(o.logWarn("Safety timeout triggered for range download with ID "+m),p(u.elem,"Timeout (Retry?)"),u.elem.title="Range download request timed out. Click to try again.",u.elem.style.backgroundColor="#d30029",u.elem.style.cursor="pointer",u.elem.onclick=d,r[m].state="Error")},15e3),G=setTimeout(()=>{const b=r[m];if(b&&(b.state==="Downloading"||b.state==="Preparing")){const a=b.lastProgressTime||0,N=Date.now()-a;N>3e5&&(o.logWarn("Range download completion safety timeout triggered for ID "+m+". Download seems stuck for "+N/1e3+"s"),N>18e5?(o.logInfo("Assuming potential silent completion for range download "+m),k(u.elem),u.elem.style.backgroundColor="#19a352",p(u.elem,"Downloaded!"),u.elem.title="Range download likely completed (auto-detected)",u.elem.onclick=null,r[m].state="Downloaded",r[m].resetTimer=window.setTimeout(()=>L(m),1e4)):(o.logInfo("Marking range download "+m+" as potentially stuck"),p(u.elem,"Downloading range... (may be stuck)")))}},18e5);o.logInfo("Sending range download message:",{type:"DOWNLOAD_SET_RANGE",url:u.originalUrl,start:D,end:h,downloadId:m}),F({type:"DOWNLOAD_SET_RANGE",url:u.originalUrl,start:D,end:h,downloadId:m},"handleRangeDownload").then(b=>{clearTimeout(x),o.logInfo("Range download response:",b),r[m]&&r[m].state==="Preparing"&&(o.logInfo("Manually transitioning range button from Preparing to Downloading state for "+m),p(u.elem,"Downloading... (Click to Pause)"),u.elem.style.background="linear-gradient(90deg, #ff5419 0%, transparent 0%)",u.elem.style.cursor="pointer",u.elem.onclick=A(m),r[m].state="Downloading",r[m].lastProgressTime=Date.now())}).catch(b=>{clearTimeout(x),clearTimeout(G),o.logError("Range download request failed:",b),r[m]&&(k(u.elem),u.elem.style.backgroundColor="#d30029",p(u.elem,"ERROR",b?.message||"Range download failed"),u.elem.onclick=null,r[m].state="Error")})})},e.appendChild(i)}},$=e=>{e.parentNode.removeChild(e)},H=e=>{const t=document.querySelectorAll(e);for(let l=0;l<t.length;l++){const n=t[l];$(n)}},fe=()=>{const e="a.sc-buylink";H(e);const t={selector:e,callback:l=>$(l)};R?.addEvent(t)},we=()=>{H("button.sc-button-download")},be=()=>{const e=window.location.pathname,t=e.split("/").filter(d=>d.length>0);if(!(!e.startsWith("/search/")&&!e.includes("/sets/")&&!e.includes("/albums/")&&t.length===2)){o.logDebug("[TrackPage] Path '"+e+"' does not appear to be an individual track page. Skipping button addition for this handler.");return}const l=".sc-button-group-medium > .sc-button-like";o.logDebug("[TrackPage] Querying for selector: "+l+" on likely track page: "+e);const n=d=>{o.logDebug("[TrackPage] Found node matching selector:",d);const f=window.location.origin+window.location.pathname,i=W(f);U(d.parentNode,i,!1)};document.querySelectorAll(l).forEach(n);const s={selector:l,callback:n};R?.addEvent(s),o.logDebug("[TrackPage] Initial elements found: "+document.querySelectorAll(l).length)},ye=()=>{const e=".sound.streamContext .sc-button-group > .sc-button-like";o.logDebug("[Feed] Querying for selector: "+e);const t=n=>{o.logDebug("[Feed] Found node matching selector:",n);const s=n.parentElement.closest(".sound__body").querySelector("a.soundTitle__title");if(s===null)return;const d=window.location.origin+s.getAttribute("href"),f=W(d);U(n.parentNode,f,!0)};document.querySelectorAll(e).forEach(t);const l={selector:e,callback:t};R?.addEvent(l),o.logDebug("[Feed] Initial elements found: "+document.querySelectorAll(e).length)},De=e=>{let t=document.querySelector("#repost-blocker");if(e){if(t){o.logWarn("Repost-Blocker script has already been injected!");return}const l=ae("/js/repostBlocker-scdl.js");if(!l)return;o.logInfo("Start blocking reposts"),t=document.createElement("script"),t.type="text/javascript",t.id="repost-blocker",t.src=l,document.documentElement.appendChild(t)}else{if(!t)return;o.logInfo("Stop blocking reposts");const l=document.createElement("script");l.type="text/javascript",l.id="cleanup-repost-blocker",l.innerText="XMLHttpRequest.prototype.resetSend();",document.documentElement.appendChild(l),document.documentElement.removeChild(t),document.documentElement.removeChild(l)}},Z=async()=>{if(J&&V){o.logDebug("[handlePageLoaded] Initialization already scheduled or in progress, skipping duplicate call.");return}J=!0,o.logInfo("[handlePageLoaded] Executing for path: "+window.location.pathname),setTimeout(async()=>{R&&(R.stop(),o.logDebug("[handlePageLoaded] Stopped previous DomObserver.")),R=new ie,fe(),we(),H(".scdl-button-placement-wrapper"),H(".scdl-generated-group"),be(),ye(),Ie(),_e(),R.start(document.body),o.logInfo("[handlePageLoaded] DomObserver started/restarted for path: "+window.location.pathname),J=!1,V=!0},250)},he=()=>{B=window.location.pathname,o.logInfo("[Framework] Initial pathname set for polling: "+B),Z(),setInterval(()=>{window.location.pathname!==B&&(o.logInfo("[Framework] URL pathname changed from '"+B+"' to '"+window.location.pathname+"'. Re-initializing buttons."),B=window.location.pathname,Z())},750)};let ee=!1;const oe=()=>{ee?o.logDebug("[Framework] guardedInitPageAndPolling: Initial setup already done. Skipping redundant call."):(ee=!0,he())},q=document.readyState;(q==="complete"||q==="interactive")&&setTimeout(oe,100),document.addEventListener("DOMContentLoaded",()=>{setTimeout(oe,100)});const Ie=()=>{o.logInfo("[PlaylistPage] Running playlist button initialization V2 (Unified Logic)");const e=window.location.pathname;if(e.startsWith("/search/")){o.logDebug("[PlaylistPage] Detected a search page ('"+e+"'), skipping playlist-wide button for this handler.");return}if(!(e.includes("/sets/")||e.includes("/albums/")||e.includes("/discover/sets/your-moods:")||document.querySelector(".setTrackList")!==null||document.querySelector(".trackList")!==null||document.querySelector(".systemPlaylistTrackList__list")!==null||document.querySelector(".mixedSelection")!==null)){o.logDebug("[PlaylistPage] Not a recognized playlist/set page, skipping.");return}o.logInfo("[PlaylistPage] Detected a playlist/set page, proceeding with button placement.");let t=null;const l=[{selector:".systemPlaylistDetails__controls",createWrapper:!0,wrapperClass:"systemPlaylistDetails__button scdl-button-placement-wrapper",groupClass:null},{selector:".mixedSelection__actions",createWrapper:!0,wrapperClass:"systemPlaylistDetails__button scdl-button-placement-wrapper",groupClass:null},{selector:".soundHeader__actions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"},{selector:".soundActions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"},{selector:".setActions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"},{selector:".listenEngagement__actions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"}];for(const n of l){const s=document.querySelector(n.selector);if(s){if(o.logDebug("[PlaylistPage] Matched container strategy with selector: "+n.selector),n.createWrapper&&n.wrapperClass){let d=s.querySelector("."+n.wrapperClass.replace(/ /g,"."));if(d&&d.closest(n.selector)===s)o.logDebug("[PlaylistPage] Reusing existing SCDL wrapper: "+n.wrapperClass);else{d=document.createElement("div"),d.className=n.wrapperClass;const f=Array.from(s.querySelectorAll(":scope > .systemPlaylistDetails__button:not(.scdl-button-placement-wrapper)"));if(f.length>0){const i=f[f.length-1];i.nextSibling?s.insertBefore(d,i.nextSibling):s.appendChild(d),o.logInfo("[PlaylistPage] Inserted SCDL wrapper after last native button in: "+n.selector)}else{const i=s.querySelector(":scope > .systemPlaylistDetails__description");i?(s.insertBefore(d,i),o.logInfo("[PlaylistPage] Inserted SCDL wrapper before description (no native buttons) in: "+n.selector)):(s.appendChild(d),o.logInfo("[PlaylistPage] Appended SCDL wrapper (no native buttons or description) in: "+n.selector))}}t=d}else if(n.groupClass){const d="."+n.groupClass.replace(/ /g,".");let f=s.querySelector(d+":not(.scdl-generated-group)");f||(f=s.querySelector(d+".scdl-generated-group")),f&&f.closest(n.selector)===s?o.logDebug("[PlaylistPage] Using existing button group in '"+n.selector+"'."):(f=document.createElement("div"),f.className=n.groupClass+" scdl-generated-group",s.appendChild(f),o.logInfo("[PlaylistPage] Created new '"+n.groupClass+"' in '"+n.selector+"'.")),t=f}if(t)break}}if(t){if(t.querySelector("button.sc-button-download")){o.logInfo("[PlaylistPage] Download buttons already exist in the determined parent. Skipping re-addition.",t);return}const n=window.location.origin+window.location.pathname,s=W(n);s.isSet=!0,o.logInfo("[PlaylistPage] Adding download buttons to determined final parent:",t),U(t,s,!1)}else o.logError("[PlaylistPage] CRITICAL: Could not find or create a suitable parent element for playlist download buttons after all strategies.")},_e=()=>{const e=window.location.pathname;if(!e.startsWith("/search/sets"))return;o.logDebug("[SearchPagePlaylists] Initializing for playlist search results on path: "+e);const t=n=>{o.logDebug("[SearchPagePlaylists] Processing playlist item:",n);const s=n.querySelector("a.soundTitle__title");let d=n.querySelector(".soundFooter .soundActions .sc-button-group")||n.querySelector(".sound__footer .soundActions .sc-button-group")||n.querySelector(".soundActions .sc-button-group");if(!s||!s.getAttribute("href")){o.logWarn("[SearchPagePlaylists] Could not find title link or valid href for item:",n);return}if(!d&&(d=n.querySelector(".soundFooter .soundActions")||n.querySelector(".sound__footer .soundActions")||n.querySelector(".soundActions"),!d)){o.logWarn("[SearchPagePlaylists] Could not find a suitable button parent (.soundActions or .sc-button-group) for item:",n);return}if(d.querySelector("button.sc-button-download")){o.logDebug("[SearchPagePlaylists] Download button already exists for this item.",n);return}let f=s.getAttribute("href");if(!f){o.logError("[SearchPagePlaylists] Playlist href is null after initial check for item:",n);return}let i=f;i.startsWith("http")||(i=window.location.origin+i),o.logInfo(`[SearchPagePlaylists] Adding button for playlist URL: ${i}`);const _=W(i);U(d,_,!0)},l="div.searchItem > div.sound.searchItem__trackItem.playlist";document.querySelectorAll(l).forEach(n=>t(n)),R?.addEvent({selector:l,callback:n=>t(n)}),o.logDebug("[SearchPagePlaylists] Added observer for selector: "+l)};let T=null;function Se(){T!==null&&clearInterval(T),T=window.setInterval(()=>{const e=Date.now(),t=Object.keys(r);t.length!==0&&(o.logDebug("Running stuck download check for "+t.length+" active downloads"),t.forEach(l=>{const n=r[l];if(n&&n.state==="Downloading"){const s=n.lastProgressTime||0,d=e-s;d>3e5&&(o.logWarn("Download "+l+" has been idle for "+Math.floor(d/1e3)+"s"),d>6e5?(o.logInfo("Auto-completing download "+l+" due to long inactivity ("+Math.floor(d/1e3)+"s)"),k(n.elem),n.elem.style.backgroundColor="#19a352",n.elem.title="Download likely completed (auto-detected)",n.elem.onclick=null,n.state="Downloaded",n.resetTimer&&clearTimeout(n.resetTimer),n.resetTimer=window.setTimeout(()=>L(l),1e4)):(p(n.elem,"Downloading... (may be stuck)"),n.elem.title="No progress for "+Math.floor(d/6e4)+" minutes. Click to pause/resume."))}}))},6e4),o.logInfo("Started automatic stuck download checker")}function ke(){T!==null&&(clearInterval(T),T=null,o.logInfo("Stopped automatic stuck download checker"))}window.onbeforeunload=()=>{R?.stop(),ke(),o.logInfo("Unattached!")};function j(){Se()}(q==="complete"||q==="interactive")&&setTimeout(j,1e3),document.addEventListener("DOMContentLoaded",()=>{setTimeout(j,1e3)});function Pe(e,t){const l=JSON.stringify(t);window.localStorage.setItem("SOUNDCLOUD-DL-"+e,l)}o.logInfo("[ContentScript] Requesting configuration from background script..."),F({type:"GET_EXTENSION_CONFIG"},"ContentScript_GetConfig").then(e=>{if(!e){o.logError("[ContentScript] Failed to load configuration from background script. Received undefined or null.");return}o.logInfo("[ContentScript] Configuration received from background:",e);for(const l of Object.keys(e))if(se.includes(l)){const n=l;Pe(n,e[n]?.value)}const t=e["block-reposts"];t&&typeof t.value=="boolean"?(o.logInfo("[ContentScript] Setting up block-reposts based on received config: "+t.value),De(t.value)):o.logWarn("[ContentScript] 'block-reposts' configuration not found or invalid in object from background."),o.logInfo("[ContentScript] Initial configuration applied.")}).catch(e=>{o.logError("[ContentScript] Error requesting or processing configuration from background script:",e)});const A=e=>async()=>{const t=r[e];if(!t){o.logWarn("Pause/Resume: Button data not found for downloadId: "+e);return}if(!e){o.logError("Attempted to send PAUSE/RESUME command with undefined/empty downloadId.");return}const l=t.state;l==="Downloading"||l==="Resuming"?(o.logInfo("[PAUSE_CLICK] User clicked Pause for "+e+". Current state: "+l+". Transitioning to Pausing."),p(t.elem,"Pausing..."),t.elem.style.cursor="default",t.elem.onclick=null,t.state="Pausing",t.lastProgressTime=Date.now(),await F({type:"PAUSE_DOWNLOAD",downloadId:e},"createPauseResumeHandler-Pause")):l==="Paused"?(o.logInfo("[RESUME_CLICK] User clicked Resume for "+e+". Current state: "+l+". Transitioning to Resuming."),p(t.elem,"Resuming..."),t.elem.style.cursor="default",t.elem.onclick=null,t.state="Resuming",t.lastProgressTime=Date.now(),await F({type:"RESUME_DOWNLOAD",downloadId:e},"createPauseResumeHandler-Resume")):o.logWarn("[PAUSE_RESUME_CLICK] Clicked on button for "+e+" but state is '"+l+"', not Downloading/Resuming or Paused. No action taken.")};function L(e,t="Idle"){const l=r[e];if(!l)return;const{elem:n,onClick:s}=l;k(n),setTimeout(()=>{r[e]&&(p(n,t==="Error"?"ERROR":"Download"),n.title=t==="Error"?"Error occurred":"Download",n.style.cursor="pointer",n.onclick=s,r[e].state=t==="Error"?"Error":"Idle",t==="Idle"&&delete r[e])},500)}let Q=null,te=!1;function ne(){te||(te=!0,Q!==null&&clearInterval(Q),Q=window.setInterval(()=>{const e=Object.keys(r);e.length!==0&&(o.logDebug("DEBUG: Currently tracking "+e.length+" active downloads"),e.forEach(t=>{const l=r[t];l&&o.logDebug("DEBUG: Download "+t+" - State="+l.state+", browserDownloadId="+(l.browserDownloadId||"none")+", lastProgress="+(l.lastProgressTime?new Date(l.lastProgressTime).toISOString():"none"))}))},1e4),o.logInfo("Started debug logging for downloads"))}const Ce=()=>{document.readyState==="complete"||document.readyState==="interactive"?setTimeout(ne,2e3):document.addEventListener("DOMContentLoaded",()=>{setTimeout(ne,2e3)})};Ce();const ve=()=>{document.readyState==="complete"||document.readyState==="interactive"?setTimeout(j,1e3):document.addEventListener("DOMContentLoaded",()=>{setTimeout(j,1e3)})};ve();
