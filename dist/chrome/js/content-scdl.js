import{L as K}from"./logger-scdl-C1suKzoJ.js";import{o as Y,l as le,g as ae,m as re}from"./compatibilityStubs-scdl-DBF9jRnU.js";import{a as se}from"./config-scdl-CB4onbqr.js";class ie{observer;events=[];unqiueNodeId=0;logger;constructor(){this.observer=new MutationObserver(t=>t.forEach(n=>this.handleMutation(n))),this.logger=K.create("Observer")}start(t){this.observer.observe(t,{subtree:!0,attributes:!0,childList:!0}),this.logger.logDebug("Started")}stop(){this.observer.disconnect(),this.logger.logDebug("Stopped")}addEvent(t){if(!t.selector){this.logger.logWarn("Selector was not specified");return}if(!t.callback){this.logger.logWarn("Callback was not specified");return}this.events.push(t),this.logger.logDebug("Event added",t)}removeEvent(t){this.events=this.events.filter(n=>n.name!==t)}handleMutation(t){const n=t.target,l=t.addedNodes??[];for(const s of this.events)l.length>0?this.handleNodes(l,s):t.type==="attributes"&&this.handleNodes([n],s,!1)}handleNodes(t,n,l=!0){if(t)for(let s=0;s<t.length;s++){const d=t[s];if(this.matchesSelectors(d,n.selector)){if(d._id!==void 0)return;d._id=++this.unqiueNodeId,n.callback(d)}l&&d.childNodes?.length>0&&this.handleNodes(d.childNodes,n)}}matchesSelectors(t,n){return t&&t instanceof HTMLElement&&t.matches(n)}}const de=`
  #scdl-range-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
  }
  #scdl-range-modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 350px;
    border-radius: 5px;
    color: #333; /* Ensure text is visible */
  }
  #scdl-range-modal label {
    display: block;
    margin-bottom: 5px;
  }
  #scdl-range-modal input[type="number"] {
    width: 60px;
    padding: 5px;
    margin-bottom: 15px;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
  }
  #scdl-range-modal-actions button {
    padding: 8px 15px;
    margin-left: 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  #scdl-range-modal-download {
    background-color: #ff5419;
    color: white;
  }
  #scdl-range-modal-cancel {
    background-color: #ccc;
  }
  #scdl-range-modal-error {
    color: red;
    font-size: 0.9em;
    margin-top: 10px;
    display: none; /* Hidden by default */
  }
  .sc-button-download {
    transition: background-color 0.5s ease-out;
  }
`;let P=null;function ce(){if(document.getElementById("scdl-range-modal"))return;const e=document.createElement("style");e.textContent=de,document.head.appendChild(e),P=document.createElement("div"),P.id="scdl-range-modal",P.innerHTML=`
    <div id="scdl-range-modal-content">
      <h4>Download Playlist Range</h4>
      <label for="scdl-range-from">From track:</label>
      <input type="number" id="scdl-range-from" name="from" min="1" value="1">
      <label for="scdl-range-to">To track:</label>
      <input type="number" id="scdl-range-to" name="to" min="1" value=""><br>
      <small>(Leave "To" blank to download until the end)</small>
      <div id="scdl-range-modal-error"></div>
      <div id="scdl-range-modal-actions" style="text-align: right; margin-top: 15px;">
        <button id="scdl-range-modal-cancel">Cancel</button>
        <button id="scdl-range-modal-download">Download Selection</button>
      </div>
    </div>
  `,document.body.appendChild(P),document.getElementById("scdl-range-modal-cancel").addEventListener("click",q),P.addEventListener("click",t=>{t.target===P&&q()})}function ge(e,t){P||ce();const n=document.getElementById("scdl-range-from"),l=document.getElementById("scdl-range-to"),s=document.getElementById("scdl-range-modal-error");n.value="1",l.value="",s.textContent="",s.style.display="none";const d=document.getElementById("scdl-range-modal-download"),I=d.cloneNode(!0);d.parentNode.replaceChild(I,d),I.addEventListener("click",()=>{const c=parseInt(n.value,10),_=l.value,f=_?parseInt(_,10):null;if(s.textContent="",s.style.display="none",isNaN(c)||c<1){s.textContent='Invalid "From" number.',s.style.display="block";return}if(f!==null&&(isNaN(f)||f<c)){s.textContent='Invalid "To" number. Must be greater than or equal to "From".',s.style.display="block";return}t(c,f),q(),p(e,"Preparing..."),e.style.cursor="default",e.onclick=null}),P.style.display="block"}function q(){P&&(P.style.display="none")}let R=null;const o=K.create("ContentScript");let B="",j=!1,V=!1;const ue=le,F=(e,t)=>{let n={};try{n=JSON.parse(JSON.stringify(e))}catch{n={errorParsingMessage:!0,originalType:e?.type}}if(o.logDebug("[ContentScript sendMessageToBackend CALLED [Context: "+(t||"Unknown")+"] Message:]",n),e&&typeof e=="object"){if(["DOWNLOAD","DOWNLOAD_SET","DOWNLOAD_SET_RANGE","PAUSE_DOWNLOAD","RESUME_DOWNLOAD"].includes(e.type)&&(!e.downloadId||e.downloadId===void 0||e.downloadId==="undefined")){const l=new Error("CRITICAL: Prevented sending message with type "+e.type+" and missing downloadId!");return o.logError("[ContentScript loggedSendMessageToBackend]",l.message,{message:n,callContext:t}),Promise.reject(l)}e.timestamp||(e.timestamp=Date.now())}return ue(e)},r={},p=(e,t,n)=>{e.innerText=t,e.title=n??t},S=e=>{e.style.backgroundColor="",e.style.background="",e.style.color=""},me=(e,t)=>{const n=crypto.randomUUID().substring(0,8),l=Object.keys(r);let s="<payload_serialization_error>";try{s=JSON.stringify(e)}catch{}let d="<sender_serialization_error>";try{d=JSON.stringify(t)}catch{}o.logDebug("[HANDLE_MSG_FROM_BG_ENTRY_POINT CALL_ID: "+n+"] Invoked. Payload: "+s+". Sender: "+d+". Current downloadButton keys: "+(l.join(",")||"none"));const I=["downloadId","progress","error","status","browserDownloadId","originalDownloadId","completionWithoutId","completed","success","timestamp","scdl_test_message"],c=Object.keys(e||{}),_=c.some(C=>I.includes(C));if(!_&&c.length>0)return o.logWarn("[HANDLE_MSG_FROM_BG] Discarding irrelevant message by key filter. Payload:",JSON.parse(JSON.stringify(e))),Promise.resolve({handled:!1,reason:"Irrelevant message"});_&&o.logDebug("[HANDLE_MSG_FROM_BG] Relevant message PASSED initial filter. Payload:",JSON.parse(JSON.stringify(e)));const{downloadId:f,progress:i,error:b,status:y,completionWithoutId:m,completed:g,timestamp:x,browserDownloadId:G,originalDownloadId:w}=e;let a;if(w?(a=w,o.logDebug("[CS_FID_LOGIC CALL_ID: "+n+"] finalDownloadId set from message.originalDownloadId: "+a)):f?(a=f,o.logDebug("[CS_FID_LOGIC CALL_ID: "+n+"] finalDownloadId set from message.downloadId: "+a)):(o.logWarn("[CS_FID_LOGIC CALL_ID: "+n+"] Message has neither originalDownloadId nor downloadId at the top level of payload."),e&&e.error&&e.originalMessage&&typeof e.originalMessage.downloadId=="string"&&(a=e.originalMessage.downloadId,o.logInfo("[CS_FID_LOGIC CALL_ID: "+n+"] finalDownloadId recovered from message.originalMessage.downloadId due to error payload from bridge: "+a))),!a&&G){const C=Object.keys(r).filter(h=>r[h].browserDownloadId===G);if(C.length===1){if(a=C[0],o.logDebug("[CS_FID_LOGIC] finalDownloadId set from browserDownloadId match: "+a),i===101||g===!0){const h=r[a];return S(h.elem),h.elem.style.backgroundColor="#19a352",p(h.elem,"Downloaded!"),h.elem.title="Downloaded successfully (matched by browser downloadId)",h.elem.onclick=null,h.state="Downloaded",h.resetTimer=window.setTimeout(()=>L(a),1e4),o.logDebug("[CS_FID_LOGIC] Updated button "+a+" to Downloaded state from browserDownloadId match"),Promise.resolve({handled:!0,id:a})}}else C.length>1&&o.logWarn("[CS_FID_LOGIC] Found multiple ("+C.length+") buttons with browserDownloadId="+G+". Cannot reliably map message.")}if(!a||a==="undefined_completion"||m){o.logWarn("[CS_GENERIC_MATCH_ENTRY] Entering generic/undefined ID matching. finalDownloadId: "+a+", is_undefined_completion: "+(a==="undefined_completion")+", completionWithoutId flag: "+m+". Message payload:",JSON.parse(JSON.stringify(e)));const C=["Downloading","Preparing","Finishing","Pausing","Resuming"],h=Object.keys(r).filter(k=>C.includes(r[k].state)),O=i===void 0&&y===void 0&&g!==!0&&m!==!0&&b===void 0&&typeof e=="object"&&Object.keys(e).length<=(w?5:e.type?2:1);if(h.length===0&&O)return o.logWarn("[HANDLE_MSG_FROM_BG] Received minimal message (keys: "+(Object.keys(e).join(", ")||"none")+") with no active downloads. Discarding.",{message:e}),Promise.resolve({handled:!1,reason:"Minimal message, no active downloads"});if(o.logWarn("[HANDLE_MSG_FROM_BG] Received message (keys: "+(Object.keys(e).join(", ")||"none")+") without a usable finalDownloadId or it is a generic completion. Attempting to match with active downloads (found "+h.length+" using states: "+C.join(", ")+")."),i===101||i===102||g===!0||m===!0||y===void 0&&b===void 0&&typeof e=="object"&&Object.keys(e).length<=(w?5:4)){const k=h;if(o.logWarn("[HANDLE_MSG_FROM_BG] Attempting to match as completion message. Found "+k.length+" candidates using states: "+C.join(", ")+"."),k.length===1){const M=k[0];if(o.logWarn("[HANDLE_MSG_FROM_BG] Matched undefined/generic ID message to single active download: "+M),a=M,i===101||i===102||g===!0||m===!0){const E=r[a];return S(E.elem),E.elem.style.backgroundColor="#19a352",p(E.elem,"Downloaded!"),E.elem.title="Downloaded successfully (auto-matched generic completion)",E.elem.onclick=null,E.state="Downloaded",E.resetTimer=window.setTimeout(()=>L(a),1e4),o.logWarn("[HANDLE_MSG_FROM_BG] Updated button "+a+" to Downloaded state from matched generic completion message."),Promise.resolve({handled:!0,id:a})}}else if(k.length>1&&x){let M=null,E=0;if(k.forEach(v=>{const X=r[v].lastProgressTime||0;X>E&&(E=X,M=v)}),M){if(o.logWarn("[HANDLE_MSG_FROM_BG] Matched undefined/generic ID to most recent active download by timestamp: "+M),a=M,i===101||i===102||g===!0||m===!0){const v=r[a];return S(v.elem),v.elem.style.backgroundColor="#19a352",p(v.elem,"Downloaded!"),v.elem.title="Downloaded successfully (auto-matched generic completion by timestamp)",v.elem.onclick=null,v.state="Downloaded",v.resetTimer=window.setTimeout(()=>L(a),1e4),o.logWarn("[HANDLE_MSG_FROM_BG] Updated button "+a+" to Downloaded state from timestamp-matched generic completion message."),Promise.resolve({handled:!0,id:a})}}else o.logWarn("[HANDLE_MSG_FROM_BG] Found "+k.length+" active downloads, but couldn't match generic completion message by timestamp.")}else k.length>0?o.logWarn("[HANDLE_MSG_FROM_BG] Found "+k.length+" active downloads, can't match generic completion message reliably by unique or timestamp."):o.logWarn("[HANDLE_MSG_FROM_BG] No active downloads to match generic completion message to.")}if(!a)return h.length===0&&O?o.logWarn("[HANDLE_MSG_FROM_BG] Could not determine finalDownloadId for minimal message (no active downloads) after matching attempts. Discarding.",{message:e}):o.logWarn("[HANDLE_MSG_FROM_BG] Could not determine finalDownloadId from generic message after all attempts. Discarding.",{message:e}),Promise.resolve({handled:!1,reason:"Could not determine finalDownloadId from generic message"})}if(!a)return o.logDebug("[HANDLE_MSG_FROM_BG] CRITICAL: finalDownloadId is null/undefined after all matching attempts. Discarding message.",e),Promise.resolve({handled:!1,reason:"finalDownloadId null after all matching"});const N=r[a];if(!N){const C=typeof e.error=="object"&&e.error!==null,h=typeof e.error=="string"&&e.error!=="";if(e.progress!==void 0&&e.progress>=100&&e.progress<=102||e.completed===!0||C||h){const O="progress: "+e.progress+", completed: "+e.completed+", error: '"+(e.error||"none")+"'";return o.logInfo("[HANDLE_MSG_FROM_BG CALL_ID: "+n+"] Button data not found for finalDownloadId: "+a+". Classified as late finalization ("+O+"). Likely already cleaned up. Message:",JSON.parse(JSON.stringify(e))),Promise.resolve({handled:!0,reason:"Button data not found, late finalization ("+O+")"})}else{const O=Object.keys(r);let k="<payload_serialization_error_in_warning>";try{k=JSON.stringify(e)}catch{}return o.logWarn("[HANDLE_MSG_FROM_BG CALL_ID: "+n+"] Button data not found for finalDownloadId: "+a+" (AND NOT a recognized late finalization type). Message: "+k+". All downloadButton keys at this point: "+O.join(",")||"none"),Promise.resolve({handled:!1,reason:"Button data not found for finalDownloadId (and not a recognized late finalization type)"})}}const{elem:u,resetTimer:ve,state:D}=N;if(o.logDebug("[HANDLE_MSG_FROM_BG] Processing for finalDownloadId: "+a+". Current button state: "+D+". Message progress: "+i+", success: "+e.success),(D==="Downloaded"||D==="Error")&&(i!==void 0||y!==void 0))return o.logWarn("[HANDLE_MSG_FROM_BG] Received message for already finalized downloadId "+a+" (state: "+D+"). Ignoring for UI update. Message:",e),Promise.resolve({handled:!0,id:a,reason:"Already in "+D+" state"});if(e.error===""&&e.success===void 0&&i===void 0&&y===void 0&&g===void 0&&D!=="Preparing"&&w===a)return o.logDebug("[HANDLE_MSG_FROM_BG] Received redundant simple acknowledgment for "+a+" while button state is "+D+". Ignoring for UI update. Payload:",JSON.parse(JSON.stringify(e))),Promise.resolve({handled:!0,id:a,reason:"Redundant simple ack, state not Preparing"});if(e.success===!0&&typeof e.message=="string"&&e.message.includes("added to queue")&&w===a&&D==="Preparing"&&i===void 0&&y===void 0&&g===void 0)o.logDebug("[HANDLE_MSG_FROM_BG] 'Added to Queue' ack for "+a+". Updating button text."),p(u,"Queued (0%)"),u.style.cursor="default",r[a].state="Queued",r[a].lastProgressTime=Date.now();else if((e.success===!0&&!b||e.error===""&&e.success===void 0)&&w===a&&D==="Preparing"&&i===void 0&&y===void 0&&g===void 0)o.logDebug("[HANDLE_MSG_FROM_BG] Initial command success (non-queue ack) for "+a+". Transitioning to Downloading state."),p(u,"Downloading... (Click to Pause)"),u.style.background="linear-gradient(90deg, #ff5419 0%, transparent 0%)",u.style.cursor="pointer",u.onclick=A(a),r[a].state="Downloading",r[a].lastProgressTime=Date.now();else if(i===101)o.logDebug("[HANDLE_MSG_FROM_BG] Download complete (101) for finalDownloadId="+a),S(u),u.style.backgroundColor="#19a352",p(u,"Downloaded!"),u.title="Downloaded successfully",u.onclick=null,r[a].state="Downloaded",r[a].resetTimer=window.setTimeout(()=>L(a),1e4);else if(i===102)o.logDebug("[HANDLE_MSG_FROM_BG] Download complete with errors (102) for finalDownloadId="+a),S(u),u.style.backgroundColor="gold",u.style.color="#333",p(u,"Downloaded!"),u.title=b||"Some tracks failed to download",u.onclick=null,r[a].state="Downloaded",r[a].resetTimer=window.setTimeout(()=>L(a),3e4);else if(y==="Paused")o.logDebug("[HANDLE_MSG_FROM_BG] Button state updated to Paused, finalDownloadId="+a),S(u),p(u,"Paused (Click to Resume)"),u.style.cursor="pointer",u.onclick=A(a),r[a].state="Paused";else if(y==="Resuming")D==="Paused"?(o.logInfo("[HANDLE_MSG_FROM_BG] Transitioning from Paused to Resuming via background message for "+a+"."),p(u,"Resuming..."),u.style.cursor="default",u.onclick=null,r[a].state="Resuming"):D==="Resuming"?o.logDebug("[HANDLE_MSG_FROM_BG] Confirmed 'Resuming' state via background message for "+a+"."):D==="Downloading"?o.logWarn("[HANDLE_MSG_FROM_BG] Received 'Resuming' status for "+a+" while already 'Downloading'. Ignoring."):o.logWarn("[HANDLE_MSG_FROM_BG] Received 'Resuming' status for "+a+" with unexpected current state '"+D+"'. Ignoring.");else if(i===100||i>100&&i<101)D!=="Paused"&&D!=="Pausing"&&D!=="Resuming"&&(o.logDebug("[HANDLE_MSG_FROM_BG] Button state updated to Finishing, finalDownloadId="+a),p(u,"Finishing..."),u.style.background="linear-gradient(90deg, #ff5419 100%, transparent 0%)",u.onclick=null,r[a].state="Finishing");else if(i!==void 0&&i>=0&&i<100){if(D==="Pausing"||D==="Paused")return o.logDebug("[HANDLE_MSG_FROM_BG] Progress update ("+i+"% for "+a+" received while state is '"+D+"'. Ignoring UI update to prevent flicker."),Promise.resolve({handled:!0,id:a,reason:"Ignoring download progress while pausing/paused"});o.logDebug("[HANDLE_MSG_FROM_BG] Button state updated to Downloading ("+i+"%), finalDownloadId="+a),p(u,"Downloading... (Click to Pause)"),u.style.background="linear-gradient(90deg, #ff5419 "+i+"%, transparent 0%)",(D!=="Downloading"||!u.onclick)&&(u.style.cursor="pointer",u.onclick=A(a)),r[a].state="Downloading",r[a]&&(r[a].lastProgressTime=Date.now())}else b?(o.logWarn("[HANDLE_MSG_FROM_BG] Button state updated to Error: "+b+", finalDownloadId="+a),S(u),u.style.backgroundColor="#d30029",p(u,"ERROR",b),u.onclick=null,r[a].state="Error"):D==="Preparing"&&i!==void 0&&(o.logDebug("[HANDLE_MSG_FROM_BG] Button state forcibly updated from Preparing to Downloading, finalDownloadId="+a),p(u,"Downloading... (Click to Pause)"),u.style.background="linear-gradient(90deg, #ff5419 "+(i||0)+"%, transparent 0%)",u.style.cursor="pointer",u.onclick=A(a),r[a].state="Downloading");return Promise.resolve({handled:!0,id:a,finalState:r[a]?.state})};o.logDebug("[CONTENT_SCRIPT_LISTENER_SETUP] Attempting to set up onMessage listener NOW."),typeof Y<"u"?(Y(me),o.logDebug("[CONTENT_SCRIPT_LISTENER_SETUP] onMessage listener setup complete. Document readyState: "+document.readyState)):o.logDebug("[CONTENT_SCRIPT_SETUP_ERROR] onMessage utility is not defined!");const pe=e=>{const t=document.createElement("button"),n=e?"sc-button-small":"sc-button-medium";return t.className="sc-button-download sc-button "+n+" sc-button-responsive",p(t,"Download"),t},z=e=>{const t=e.includes("/sets/")||e.includes("/albums/");o.logDebug("createDownloadCommand: URL="+e+", isSetUrl="+t,{url:e,isSetUrl:t});const n=l=>l?F({type:t?"DOWNLOAD_SET":"DOWNLOAD",url:e,downloadId:l},"createDownloadCommand"):(o.logError("Attempted to send DOWNLOAD command with undefined/empty downloadId",{url:e}),Promise.reject("Undefined/empty downloadId for DOWNLOAD command"));return n.url=e,n.isSet=t,o.logDebug("createDownloadCommand: Created command with isSet="+n.isSet+", commandUrl: "+n.url+", isSet: "+n.isSet),n},J=(e,t,n)=>{if(e.querySelector("button.sc-button-download")!==null){o.logDebug("Download button already exists");return}o.logDebug("Adding download button",{parentNode:e.nodeName,url:t.url,isSet:t.isSet});const l=pe(n),s=t.url;o.logInfo("Button created with URL: "+s);const d=async()=>{const c=crypto.randomUUID();r[c]={elem:l,onClick:d,state:"Preparing",originalUrl:s,lastProgressTime:Date.now()},o.logInfo("Button clicked with downloadId: "+c+", URL: "+s),l.style.cursor="default",l.onclick=null,p(l,"Preparing..."),S(l);const _=setTimeout(()=>{const i=r[c];i&&i.state==="Preparing"&&(o.logWarn("Safety timeout triggered for downloadId="+c+", button still in Preparing state"),p(l,"Timeout (Retry?)"),l.title="Download request timed out. Click to try again.",l.style.backgroundColor="#d30029",l.style.cursor="pointer",l.onclick=d,r[c].state="Error")},1e4),f=setTimeout(()=>{const i=r[c];if(i&&i.state==="Downloading"){const b=i.lastProgressTime||0,y=Date.now()-b;y>12e4&&(o.logWarn("Completion safety timeout triggered for downloadId="+c+". Download seems stuck in Downloading state for "+y/1e3+"s"),y>18e4?(o.logInfo("Assuming potential silent completion for downloadId="+c),S(l),l.style.backgroundColor="#19a352",p(l,"Downloaded!"),l.title="Download likely completed (auto-detected)",l.onclick=null,r[c].state="Downloaded",r[c].resetTimer=window.setTimeout(()=>L(c),1e4)):(o.logInfo("Marking download "+c+" as potentially stuck"),p(l,"Downloading... (may be stuck)")))}},3e5);try{const i=await t(c);o.logInfo("Download command response for "+c+":",i),clearTimeout(_);const b=r[c];b&&b.state==="Preparing"&&(o.logInfo("Manually transitioning button from Preparing to Downloading state for "+c),p(l,"Downloading... (Click to Pause)"),l.style.background="linear-gradient(90deg, #ff5419 0%, transparent 0%)",l.style.cursor="pointer",l.onclick=A(c),r[c].state="Downloading",r[c].lastProgressTime=Date.now())}catch(i){clearTimeout(_),clearTimeout(f),o.logError("Initial download command failed for "+s,i),r[c]&&(r[c].state="Error",p(l,"ERROR",i.message||"Failed to start"),l.style.backgroundColor="#d30029")}};l.oncontextmenu=c=>{c.preventDefault(),c.stopPropagation();const _=document.getElementById("scdl-context-menu");_&&document.body.removeChild(_);const f=document.createElement("div");f.id="scdl-context-menu",f.style.position="absolute",f.style.left=""+c.pageX+"px",f.style.top=""+c.pageY+"px",f.style.background="#fff",f.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",f.style.padding="5px 0",f.style.borderRadius="3px",f.style.zIndex="10000",document.body.appendChild(f);const i=()=>{document.getElementById("scdl-context-menu")&&document.body.removeChild(f),document.removeEventListener("click",i)};return document.addEventListener("click",i),!1},l.onclick=d,e.appendChild(l);const I=t.isSet;if(o.logInfo("Checking if should add range button:",{isSet:I,url:t.url,urlIncludes:{sets:t.url?.includes("/sets/"),albums:t.url?.includes("/albums/")},browserType:typeof browser<"u"?"Firefox":"Chrome"}),re(s,I)){const c=document.createElement("button");o.logInfo("Creating range button for URL="+(t.url||"unknown"));const _=n?"sc-button-small":"sc-button-medium";c.className="sc-button-range sc-button "+_+" sc-button-responsive",c.textContent="Range...",c.title="Download a range of tracks",c.style.marginLeft="5px",c.onclick=f=>{f.preventDefault(),f.stopPropagation();const i=crypto.randomUUID();r[i]={elem:l,onClick:d,state:"Idle",originalUrl:s,lastProgressTime:Date.now()},o.logInfo("Range button clicked. Created preDownloadId: "+i+", with URL: "+s),ge(l,(b,y)=>{const m=i;o.logInfo("Range download handler called with start="+b+", end="+y+", mainButtonId="+m);const g=r[m];if(o.logInfo("Button data for range download:",{hasButtonData:!!g,originalUrl:g?.originalUrl,state:g?.state}),!g||!g.originalUrl){o.logError("Range download failed: No button data or URL for ID "+m);const w=document.getElementById("scdl-range-modal-error");w&&(w.textContent="Error: Could not get original URL for the playlist.",w.style.display="block");return}p(g.elem,"Preparing..."),g.elem.style.cursor="default",g.elem.onclick=null,g.state="Preparing",g.lastProgressTime=Date.now();const x=setTimeout(()=>{r[m]&&r[m].state==="Preparing"&&(o.logWarn("Safety timeout triggered for range download with ID "+m),p(g.elem,"Timeout (Retry?)"),g.elem.title="Range download request timed out. Click to try again.",g.elem.style.backgroundColor="#d30029",g.elem.style.cursor="pointer",g.elem.onclick=d,r[m].state="Error")},15e3),G=setTimeout(()=>{const w=r[m];if(w&&(w.state==="Downloading"||w.state==="Preparing")){const a=w.lastProgressTime||0,N=Date.now()-a;N>3e5&&(o.logWarn("Range download completion safety timeout triggered for ID "+m+". Download seems stuck for "+N/1e3+"s"),N>18e5?(o.logInfo("Assuming potential silent completion for range download "+m),S(g.elem),g.elem.style.backgroundColor="#19a352",p(g.elem,"Downloaded!"),g.elem.title="Range download likely completed (auto-detected)",g.elem.onclick=null,r[m].state="Downloaded",r[m].resetTimer=window.setTimeout(()=>L(m),1e4)):(o.logInfo("Marking range download "+m+" as potentially stuck"),p(g.elem,"Downloading range... (may be stuck)")))}},18e5);o.logInfo("Sending range download message:",{type:"DOWNLOAD_SET_RANGE",url:g.originalUrl,start:b,end:y,downloadId:m}),F({type:"DOWNLOAD_SET_RANGE",url:g.originalUrl,start:b,end:y,downloadId:m},"handleRangeDownload").then(w=>{clearTimeout(x),o.logInfo("Range download response:",w),r[m]&&r[m].state==="Preparing"&&(o.logInfo("Manually transitioning range button from Preparing to Downloading state for "+m),p(g.elem,"Downloading... (Click to Pause)"),g.elem.style.background="linear-gradient(90deg, #ff5419 0%, transparent 0%)",g.elem.style.cursor="pointer",g.elem.onclick=A(m),r[m].state="Downloading",r[m].lastProgressTime=Date.now())}).catch(w=>{clearTimeout(x),clearTimeout(G),o.logError("Range download request failed:",w),r[m]&&(S(g.elem),g.elem.style.backgroundColor="#d30029",p(g.elem,"ERROR",w?.message||"Range download failed"),g.elem.onclick=null,r[m].state="Error")})})},e.appendChild(c)}},Z=e=>{e.parentNode.removeChild(e)},W=e=>{const t=document.querySelectorAll(e);for(let n=0;n<t.length;n++){const l=t[n];Z(l)}},fe=()=>{const e="a.sc-buylink";W(e);const t={selector:e,callback:n=>Z(n)};R?.addEvent(t)},we=()=>{W("button.sc-button-download")},De=()=>{const e=".sc-button-group-medium > .sc-button-like";o.logDebug("[TrackPage] Querying for selector: "+e);const t=l=>{o.logDebug("[TrackPage] Found node matching selector:",l);const s=window.location.origin+window.location.pathname,d=z(s);J(l.parentNode,d,!1)};document.querySelectorAll(e).forEach(t);const n={selector:e,callback:t};R?.addEvent(n),o.logDebug("[TrackPage] Initial elements found: "+document.querySelectorAll(e).length)},be=()=>{const e=".sound.streamContext .sc-button-group > .sc-button-like";o.logDebug("[Feed] Querying for selector: "+e);const t=l=>{o.logDebug("[Feed] Found node matching selector:",l);const s=l.parentElement.closest(".sound__body").querySelector("a.soundTitle__title");if(s===null)return;const d=window.location.origin+s.getAttribute("href"),I=z(d);J(l.parentNode,I,!0)};document.querySelectorAll(e).forEach(t);const n={selector:e,callback:t};R?.addEvent(n),o.logDebug("[Feed] Initial elements found: "+document.querySelectorAll(e).length)},ye=e=>{let t=document.querySelector("#repost-blocker");if(e){if(t){o.logWarn("Repost-Blocker script has already been injected!");return}const n=ae("/js/repostBlocker-scdl.js");if(!n)return;o.logInfo("Start blocking reposts"),t=document.createElement("script"),t.type="text/javascript",t.id="repost-blocker",t.src=n,document.documentElement.appendChild(t)}else{if(!t)return;o.logInfo("Stop blocking reposts");const n=document.createElement("script");n.type="text/javascript",n.id="cleanup-repost-blocker",n.innerText="XMLHttpRequest.prototype.resetSend();",document.documentElement.appendChild(n),document.documentElement.removeChild(t),document.documentElement.removeChild(n)}},$=async()=>{if(j&&V){o.logDebug("[handlePageLoaded] Initialization already scheduled or in progress, skipping duplicate call.");return}j=!0,o.logInfo("[handlePageLoaded] Executing for path: "+window.location.pathname),setTimeout(async()=>{R&&(R.stop(),o.logDebug("[handlePageLoaded] Stopped previous DomObserver.")),R=new ie,fe(),we(),W(".scdl-button-placement-wrapper"),W(".scdl-generated-group"),De(),be(),Ie(),R.start(document.body),o.logInfo("[handlePageLoaded] DomObserver started/restarted for path: "+window.location.pathname),j=!1,V=!0},50)},he=()=>{B=window.location.pathname,o.logInfo("[Framework] Initial pathname set for polling: "+B),$(),setInterval(()=>{window.location.pathname!==B&&(o.logInfo("[Framework] URL pathname changed from '"+B+"' to '"+window.location.pathname+"'. Re-initializing buttons."),B=window.location.pathname,$())},750)};let ee=!1;const oe=()=>{ee?o.logDebug("[Framework] guardedInitPageAndPolling: Initial setup already done. Skipping redundant call."):(ee=!0,he())},U=document.readyState;(U==="complete"||U==="interactive")&&setTimeout(oe,100),document.addEventListener("DOMContentLoaded",()=>{setTimeout(oe,100)});const Ie=()=>{if(o.logInfo("[PlaylistPage] Running playlist button initialization V2 (Unified Logic)"),!(window.location.pathname.includes("/sets/")||window.location.pathname.includes("/albums/")||window.location.pathname.includes("/discover/sets/your-moods:")||document.querySelector(".setTrackList")!==null||document.querySelector(".trackList")!==null||document.querySelector(".systemPlaylistTrackList__list")!==null||document.querySelector(".mixedSelection")!==null)){o.logDebug("[PlaylistPage] Not a recognized playlist/set page, skipping.");return}o.logInfo("[PlaylistPage] Detected a playlist/set page, proceeding with button placement.");let e=null;const t=[{selector:".systemPlaylistDetails__controls",createWrapper:!0,wrapperClass:"systemPlaylistDetails__button scdl-button-placement-wrapper",groupClass:null},{selector:".mixedSelection__actions",createWrapper:!0,wrapperClass:"systemPlaylistDetails__button scdl-button-placement-wrapper",groupClass:null},{selector:".soundHeader__actions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"},{selector:".soundActions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"},{selector:".setActions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"},{selector:".listenEngagement__actions",createWrapper:!1,groupClass:"sc-button-group sc-button-group-medium"}];for(const n of t){const l=document.querySelector(n.selector);if(l){if(o.logDebug("[PlaylistPage] Matched container strategy with selector: "+n.selector),n.createWrapper&&n.wrapperClass){let s=l.querySelector("."+n.wrapperClass.replace(/ /g,"."));if(s&&s.closest(n.selector)===l)o.logDebug("[PlaylistPage] Reusing existing SCDL wrapper: "+n.wrapperClass);else{s=document.createElement("div"),s.className=n.wrapperClass;const d=Array.from(l.querySelectorAll(":scope > .systemPlaylistDetails__button:not(.scdl-button-placement-wrapper)"));if(d.length>0){const I=d[d.length-1];I.nextSibling?l.insertBefore(s,I.nextSibling):l.appendChild(s),o.logInfo("[PlaylistPage] Inserted SCDL wrapper after last native button in: "+n.selector)}else{const I=l.querySelector(":scope > .systemPlaylistDetails__description");I?(l.insertBefore(s,I),o.logInfo("[PlaylistPage] Inserted SCDL wrapper before description (no native buttons) in: "+n.selector)):(l.appendChild(s),o.logInfo("[PlaylistPage] Appended SCDL wrapper (no native buttons or description) in: "+n.selector))}}e=s}else if(n.groupClass){const s="."+n.groupClass.replace(/ /g,".");let d=l.querySelector(s+":not(.scdl-generated-group)");d||(d=l.querySelector(s+".scdl-generated-group")),d&&d.closest(n.selector)===l?o.logDebug("[PlaylistPage] Using existing button group in '"+n.selector+"'."):(d=document.createElement("div"),d.className=n.groupClass+" scdl-generated-group",l.appendChild(d),o.logInfo("[PlaylistPage] Created new '"+n.groupClass+"' in '"+n.selector+"'.")),e=d}if(e)break}}if(e){if(e.querySelector("button.sc-button-download")){o.logInfo("[PlaylistPage] Download buttons already exist in the determined parent. Skipping re-addition.",e);return}const n=window.location.origin+window.location.pathname,l=z(n);l.isSet=!0,o.logInfo("[PlaylistPage] Adding download buttons to determined final parent:",e),J(e,l,!1)}else o.logError("[PlaylistPage] CRITICAL: Could not find or create a suitable parent element for playlist download buttons after all strategies.")};let T=null;function _e(){T!==null&&clearInterval(T),T=window.setInterval(()=>{const e=Date.now(),t=Object.keys(r);t.length!==0&&(o.logDebug("Running stuck download check for "+t.length+" active downloads"),t.forEach(n=>{const l=r[n];if(l&&l.state==="Downloading"){const s=l.lastProgressTime||0,d=e-s;d>3e5&&(o.logWarn("Download "+n+" has been idle for "+Math.floor(d/1e3)+"s"),d>6e5?(o.logInfo("Auto-completing download "+n+" due to long inactivity ("+Math.floor(d/1e3)+"s)"),S(l.elem),l.elem.style.backgroundColor="#19a352",l.elem.title="Download likely completed (auto-detected)",l.elem.onclick=null,l.state="Downloaded",l.resetTimer&&clearTimeout(l.resetTimer),l.resetTimer=window.setTimeout(()=>L(n),1e4)):(p(l.elem,"Downloading... (may be stuck)"),l.elem.title="No progress for "+Math.floor(d/6e4)+" minutes. Click to pause/resume."))}}))},6e4),o.logInfo("Started automatic stuck download checker")}function ke(){T!==null&&(clearInterval(T),T=null,o.logInfo("Stopped automatic stuck download checker"))}window.onbeforeunload=()=>{R?.stop(),ke(),o.logInfo("Unattached!")};function H(){_e()}(U==="complete"||U==="interactive")&&setTimeout(H,1e3),document.addEventListener("DOMContentLoaded",()=>{setTimeout(H,1e3)});function Se(e,t){const n=JSON.stringify(t);window.localStorage.setItem("SOUNDCLOUD-DL-"+e,n)}o.logInfo("[ContentScript] Requesting configuration from background script..."),F({type:"GET_EXTENSION_CONFIG"},"ContentScript_GetConfig").then(e=>{if(!e){o.logError("[ContentScript] Failed to load configuration from background script. Received undefined or null.");return}o.logInfo("[ContentScript] Configuration received from background:",e);for(const n of Object.keys(e))if(se.includes(n)){const l=n;Se(l,e[l]?.value)}const t=e["block-reposts"];t&&typeof t.value=="boolean"?(o.logInfo("[ContentScript] Setting up block-reposts based on received config: "+t.value),ye(t.value)):o.logWarn("[ContentScript] 'block-reposts' configuration not found or invalid in object from background."),o.logInfo("[ContentScript] Initial configuration applied.")}).catch(e=>{o.logError("[ContentScript] Error requesting or processing configuration from background script:",e)});const A=e=>async()=>{const t=r[e];if(!t){o.logWarn("Pause/Resume: Button data not found for downloadId: "+e);return}if(!e){o.logError("Attempted to send PAUSE/RESUME command with undefined/empty downloadId.");return}const n=t.state;n==="Downloading"||n==="Resuming"?(o.logInfo("[PAUSE_CLICK] User clicked Pause for "+e+". Current state: "+n+". Transitioning to Pausing."),p(t.elem,"Pausing..."),t.elem.style.cursor="default",t.elem.onclick=null,t.state="Pausing",t.lastProgressTime=Date.now(),await F({type:"PAUSE_DOWNLOAD",downloadId:e},"createPauseResumeHandler-Pause")):n==="Paused"?(o.logInfo("[RESUME_CLICK] User clicked Resume for "+e+". Current state: "+n+". Transitioning to Resuming."),p(t.elem,"Resuming..."),t.elem.style.cursor="default",t.elem.onclick=null,t.state="Resuming",t.lastProgressTime=Date.now(),await F({type:"RESUME_DOWNLOAD",downloadId:e},"createPauseResumeHandler-Resume")):o.logWarn("[PAUSE_RESUME_CLICK] Clicked on button for "+e+" but state is '"+n+"', not Downloading/Resuming or Paused. No action taken.")};function L(e,t="Idle"){const n=r[e];if(!n)return;const{elem:l,onClick:s}=n;S(l),setTimeout(()=>{r[e]&&(p(l,t==="Error"?"ERROR":"Download"),l.title=t==="Error"?"Error occurred":"Download",l.style.cursor="pointer",l.onclick=s,r[e].state=t==="Error"?"Error":"Idle",t==="Idle"&&delete r[e])},500)}let Q=null,te=!1;function ne(){te||(te=!0,Q!==null&&clearInterval(Q),Q=window.setInterval(()=>{const e=Object.keys(r);e.length!==0&&(o.logDebug("DEBUG: Currently tracking "+e.length+" active downloads"),e.forEach(t=>{const n=r[t];n&&o.logDebug("DEBUG: Download "+t+" - State="+n.state+", browserDownloadId="+(n.browserDownloadId||"none")+", lastProgress="+(n.lastProgressTime?new Date(n.lastProgressTime).toISOString():"none"))}))},1e4),o.logInfo("Started debug logging for downloads"))}const Ce=()=>{document.readyState==="complete"||document.readyState==="interactive"?setTimeout(ne,2e3):document.addEventListener("DOMContentLoaded",()=>{setTimeout(ne,2e3)})};Ce();const Ee=()=>{document.readyState==="complete"||document.readyState==="interactive"?setTimeout(H,1e3):document.addEventListener("DOMContentLoaded",()=>{setTimeout(H,1e3)})};Ee();
